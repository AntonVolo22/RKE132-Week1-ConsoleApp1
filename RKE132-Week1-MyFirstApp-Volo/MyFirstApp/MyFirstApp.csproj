const bool DEBUG_DISTANCES = true;
const bool DEBUG_ACTIONS   = true;

const unsigned long START_DELAY_MS    = 3000;
const unsigned long RUN_TIME_LIMIT_MS = 300000;   // 5 –º–∏–Ω—É—Ç
const unsigned long measureInterval   = 100;

// –ü–∏–Ω—ã —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤
// TRIG: 13, 8, 9, 11, 12
// ECHO: A0..A4
const int trigPins[5] = {13, 8, 9, 11, 12};
const int echoPins[5] = {A0, A1, A2, A3, A4};

// –ú–æ—Ç–æ—Ä—ã (L298N)
const int enA = 3;
const int in1 = 2;
const int in2 = 4;
const int enB = 5;
const int in3 = 6;
const int in4 = 10;

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–≤–∏–∂–µ–Ω–∏—è
const int speedForward = 160;
const int speedSlow    = 120;
const int speedTurn    = 170;

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∞—Ç—á–∏–∫–æ–≤
const unsigned long sensorTimeout = 30000;
const int thresholdFront          = 20;
const int minValidDistance        = 2;
const int maxValidDistance        = 250;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ
long distances[5] = {999, 999, 999, 999, 999};
unsigned long lastMeasureTime = 0;
unsigned long runStartTime    = 0;
bool started                  = false;

// üîÅ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "–≤–ø–µ—Ä—ë–¥" ‚Äî –ò–ù–í–ï–†–¢–ò–†–û–í–ê–ù–û (–±—ã–ª–æ HIGH/LOW)
#define LEFT_FWD_A   LOW   // –±—ã–ª–æ HIGH
#define LEFT_FWD_B   HIGH  // –±—ã–ª–æ LOW
#define RIGHT_FWD_A  LOW   // –±—ã–ª–æ HIGH
#define RIGHT_FWD_B  HIGH  // –±—ã–ª–æ LOW


void setup() {
  Serial.begin(9600);

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤
  for (int i = 0; i < 5; i++) {
    pinMode(trigPins[i], OUTPUT);
    digitalWrite(trigPins[i], LOW);
    pinMode(echoPins[i], INPUT);
  }

  // –ú–æ—Ç–æ—Ä—ã
  pinMode(enA, OUTPUT);
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);

  pinMode(enB, OUTPUT);
  pinMode(in3, OUTPUT);
  pinMode(in4, OUTPUT);

  moveStop();

  Serial.println(F("==== ROBOTEX ROBOT (5 –¥–∞—Ç—á–∏–∫–æ–≤, 4 –º–æ—Ç–æ—Ä–∞) ===="));
  Serial.println(F("–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞..."));
}


void loop() {
  unsigned long now = millis();

  // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
  if (!started) {
    if (now >= START_DELAY_MS) {
      started      = true;
      runStartTime = now;
      Serial.println(F(">>> –°–¢–ê–†–¢! –†–æ–±–æ—Ç –Ω–∞—á–∞–ª –¥–≤–∏–∂–µ–Ω–∏–µ."));
    } else {
      moveStop();
      return;
    }
  }

  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  if (now - runStartTime >= RUN_TIME_LIMIT_MS) {
    moveStop();
    Serial.println(F(">>> –í–†–ï–ú–Ø –ó–ê–ï–ó–î–ê –ò–°–¢–ï–ö–õ–û. –†–æ–±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."));
    while (true) {
      moveStop();
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤ –ø–æ —Ç–∞–π–º–µ—Ä—É
  if (now - lastMeasureTime >= measureInterval) {
    lastMeasureTime = now;
    measureAllSensors();
    if (DEBUG_DISTANCES) {
      printDistances();
    }
  }

  // –õ–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è
  decisionLogic();
}


void decisionLogic() {
  int front = distances[2];
  int left  = min(distances[0], distances[1]);
  int right = min(distances[3], distances[4]);

  // 1) –û—á–µ–Ω—å –±–ª–∏–∑–∫–æ —Å–ø–µ—Ä–µ–¥–∏ ‚Äî —Ä–∞–∑–≤–æ—Ä–æ—Ç –Ω–∞ –º–µ—Å—Ç–µ
  if (front < thresholdFront && front > 0) {
    if (left > right) {
      if (DEBUG_ACTIONS) Serial.println(F("–°–ø–µ—Ä–µ–¥–∏ –±–ª–∏–∑–∫–æ. –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞—é –≤–ª–µ–≤–æ."));
      pivotLeft();
    } else {
      if (DEBUG_ACTIONS) Serial.println(F("–°–ø–µ—Ä–µ–¥–∏ –±–ª–∏–∑–∫–æ. –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞—é –≤–ø—Ä–∞–≤–æ."));
      pivotRight();
    }
    return;
  }

  // 2) –û–±—ä–µ–∫—Ç –Ω–µ –æ—á–µ–Ω—å –¥–∞–ª–µ–∫–æ ‚Äî –µ–¥–µ–º –º–µ–¥–ª–µ–Ω–Ω–µ–µ
  if (front < thresholdFront * 2 && front > 0) {
    if (DEBUG_ACTIONS) Serial.println(F("–û–±—ä–µ–∫—Ç –≤–ø–µ—Ä–µ–¥–∏, —Å–Ω–∏–∂–∞—é —Å–∫–æ—Ä–æ—Å—Ç—å."));
    moveForwardSlow();
    return;
  }

  // 3) –í—Å—ë —á–∏—Å—Ç–æ ‚Äî –µ–¥–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ –≤–ø–µ—Ä—ë–¥
  if (DEBUG_ACTIONS) Serial.println(F("–ü—É—Ç—å —Å–≤–æ–±–æ–¥–µ–Ω, –µ–¥—É –≤–ø–µ—Ä—ë–¥."));
  moveForward();
}


// --------- –î–≤–∏–∂–µ–Ω–∏–µ ---------

void moveForward() {
  // –õ–µ–≤—ã–π –±–æ—Ä—Ç
  digitalWrite(in1, LEFT_FWD_A);
  digitalWrite(in2, LEFT_FWD_B);
  analogWrite(enA, speedForward);

  // –ü—Ä–∞–≤—ã–π –±–æ—Ä—Ç
  digitalWrite(in3, RIGHT_FWD_A);
  digitalWrite(in4, RIGHT_FWD_B);
  analogWrite(enB, speedForward);
}

void moveForwardSlow() {
  digitalWrite(in1, LEFT_FWD_A);
  digitalWrite(in2, LEFT_FWD_B);
  analogWrite(enA, speedSlow);

  digitalWrite(in3, RIGHT_FWD_A);
  digitalWrite(in4, RIGHT_FWD_B);
  analogWrite(enB, speedSlow);
}

void moveStop() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  analogWrite(enA, 0);

  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
  analogWrite(enB, 0);
}

// –ü–æ–≤–æ—Ä–æ—Ç –Ω–∞ –º–µ—Å—Ç–µ –≤–ª–µ–≤–æ: –ª–µ–≤—ã–π –Ω–∞–∑–∞–¥, –ø—Ä–∞–≤—ã–π –≤–ø–µ—Ä—ë–¥
void pivotLeft() {
  // –ª–µ–≤—ã–π –Ω–∞–∑–∞–¥ (–∏–Ω–≤–µ—Ä—Å–∏—è –≤–ø–µ—Ä—ë–¥)
  digitalWrite(in1, (LEFT_FWD_A == HIGH ? LOW : HIGH));
  digitalWrite(in2, (LEFT_FWD_B == HIGH ? LOW : HIGH));
  analogWrite(enA, speedTurn);

  // –ø—Ä–∞–≤—ã–π –≤–ø–µ—Ä—ë–¥
  digitalWrite(in3, RIGHT_FWD_A);
  digitalWrite(in4, RIGHT_FWD_B);
  analogWrite(enB, speedTurn);
}

// –ü–æ–≤–æ—Ä–æ—Ç –Ω–∞ –º–µ—Å—Ç–µ –≤–ø—Ä–∞–≤–æ: –ª–µ–≤—ã–π –≤–ø–µ—Ä—ë–¥, –ø—Ä–∞–≤—ã–π –Ω–∞–∑–∞–¥
void pivotRight() {
  // –ª–µ–≤—ã–π –≤–ø–µ—Ä—ë–¥
  digitalWrite(in1, LEFT_FWD_A);
  digitalWrite(in2, LEFT_FWD_B);
  analogWrite(enA, speedTurn);

  // –ø—Ä–∞–≤—ã–π –Ω–∞–∑–∞–¥ (–∏–Ω–≤–µ—Ä—Å–∏—è –≤–ø–µ—Ä—ë–¥)
  digitalWrite(in3, (RIGHT_FWD_A == HIGH ? LOW : HIGH));
  digitalWrite(in4, (RIGHT_FWD_B == HIGH ? LOW : HIGH));
  analogWrite(enB, speedTurn);
}


// --------- –î–∞—Ç—á–∏–∫–∏ ---------

void measureAllSensors() {
  for (int i = 0; i < 5; i++) {
    long d = measureDistance(trigPins[i], echoPins[i]);
    if (d < minValidDistance || d > maxValidDistance) {
      d = 999;
    }
    distances[i] = d;
  }
}

long measureDistance(int trigPin, int echoPin) {
  long duration;

  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);

  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  duration = pulseIn(echoPin, HIGH, sensorTimeout);
  if (duration == 0) return 999;

  long cm = duration * 0.034 / 2;
  return cm;
}


// --------- –û—Ç–ª–∞–¥–∫–∞ ---------

void printDistances() {
  Serial.print(F("D: "));
  for (int i = 0; i < 5; i++) {
    Serial.print(distances[i]);
    if (i < 4) Serial.print(F(", "));
  }
  Serial.println(F(" —Å–º"));
}
